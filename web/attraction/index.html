<!DOCTYPE HTML>
<html>
	<head>
		<title>behaviour-attraction1</title>
		<meta name="viewport" id="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<meta charset="utf-8">
		<style type="text/css">
			body {
				background-color: #333333;
				margin: 0px;
				overflow: hidden;
				-moz-user-select: none;
				-webkit-user-select: none;
				-ms-user-select: none;
				-khtml-user-select: none;
				user-select: none;
			}
			#testCanvas {
				background: #000;
			}
		</style>
	</head>
	<body>
		<canvas id="testCanvas"></canvas>
		<script src="js/stats.min.js"></script>
		<script src="js/proton-2.1.0.min.js"></script>
		<script src="http://gausstoys.com/libs/gausssense.js"></script>
		<script>
			var canvas;
			var context;
			var proton;
			var renderer;
			var emitter;
			var stats;
			var _mousedown = false;
			var mouseObj;
			var northObj, southObj;
			var attractionBehaviour, crossZoneBehaviour;
			var attractionBehaviour2;
			var gs;
			var preNorthPoints = [];
			var preSouthPoints = [];


			
			Main();
			
			function Main() {
				gs = new GaussSense();


				canvas = document.getElementById("testCanvas");
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				context = canvas.getContext('2d');
				addStats();

				createProton();
				createRenderer();
				tick();
				canvas.addEventListener('mousedown', mousedownHandler, false);
				canvas.addEventListener('mouseup', mouseupHandler, false);
				canvas.addEventListener('mousemove', mousemoveHandler, false);
				window.onresize = function(e) {
					canvas.width = window.innerWidth;
					canvas.height = window.innerHeight;
					crossZoneBehaviour.reset(new Proton.RectZone(0, 0, canvas.width, canvas.height), 'cross');
				}

				
			}

			function addStats() {
				stats = new Stats();
				stats.setMode(2);
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.left = '0px';
				stats.domElement.style.top = '0px';
				document.body.appendChild(stats.domElement);
			}

			function createProton() {
				proton = new Proton;
				emitter = new Proton.Emitter();
				emitter.damping = 0.008;
				emitter.rate = new Proton.Rate(250);
				emitter.addInitialize(new Proton.Mass(1));
				emitter.addInitialize(new Proton.Radius(4));
				emitter.addInitialize(new Proton.Velocity(new Proton.Span(1.5), new Proton.Span(0, 360), 'polar'));

				northObj = {
					x : 1003 / 2,
					y : 610 / 2
				};

				southObj = {
					x : 1003 / 2 + 100,
					y : 610 / 2
				};
				attractionBehaviour = new Proton.Attraction(northObj, 0, 0);
				attractionBehaviour2 = new Proton.Attraction(southObj, 0, 0);
				crossZoneBehaviour = new Proton.CrossZone(new Proton.RectZone(0, 0, canvas.width, canvas.height), 'cross');
				
				emitter.addBehaviour(new Proton.Color('rgba(255, 255, 255, 0.5)'));
				emitter.addBehaviour(attractionBehaviour, crossZoneBehaviour);
				emitter.addBehaviour(attractionBehaviour2, crossZoneBehaviour);
				emitter.addBehaviour(new Proton.RandomDrift(10, 10, .05));
				emitter.p.x = canvas.width / 2;
				emitter.p.y = canvas.height / 2;
				emitter.emit('once');
				proton.addEmitter(emitter);
			}


			function mousedownHandler(e) {
				_mousedown = true;
				attractionBehaviour.reset(mouseObj, 10, 1200);
				mousemoveHandler(e);
			}

			function mousemoveHandler(e) {
				if (_mousedown) {
					var _x, _y;
					if (e.layerX || e.layerX == 0) {
						_x = e.layerX;
						_y = e.layerY;
					} else if (e.offsetX || e.offsetX == 0) {
						_x = e.offsetX;
						_y = e.offsetY;
					}

					mouseObj.x = _x;
					mouseObj.y = _y;
				}
			}

			function mouseupHandler(e) {
				_mousedown = false;
				attractionBehaviour.reset(mouseObj, 0, 0);
			}

			function createRenderer() {
				renderer = new Proton.Renderer('other', proton);
				renderer.onProtonUpdate = function() {
					context.fillStyle = "rgba(0, 0, 0, 0.03)";
					context.fillRect(0, 0, canvas.width, canvas.height);
				};

				renderer.onParticleUpdate = function(particle) {
					context.beginPath();
					context.strokeStyle = particle.color;
					context.lineWidth = 2;
					context.moveTo(particle.old.p.x, particle.old.p.y);
					context.lineTo(particle.p.x, particle.p.y);
					context.closePath();
					context.stroke();
				};

				renderer.start();
			}

			function tick() {
				requestAnimationFrame(tick);


				var northPoints = gs.getNorthGaussBits();
				var southPoints = gs.getSouthGaussBits();

				if(preNorthPoints.length == 0 && northPoints.length > 0) {
					attractionBehaviour.reset(northObj, 10, 1200);
				}
				if(preNorthPoints.length > 0 && northPoints.length == 0) {
					attractionBehaviour.reset(northObj, 0, 0);
				}

				if(northPoints.length == 1) {
					northObj.x = northPoints[0].x*800 + 300;
					northObj.y = northPoints[0].y*800 + 50;
				}



				if(preSouthPoints.length == 0 && southPoints.length > 0) {
					attractionBehaviour2.reset(southObj, 10, 1200);
				}
				if(preSouthPoints.length > 0 && southPoints.length == 0) {
					attractionBehaviour2.reset(southObj, 0, 0);
				}

				if(southPoints.length == 1) {
					southObj.x = southPoints[0].x*800 + 300;
					southObj.y = southPoints[0].y*800 + 50;
				}



				preNorthPoints = northPoints.slice();
				preSouthPoints = southPoints.slice();

				stats.begin();
				proton.update();
				stats.end();
			}
		</script>
	</body>
</html>